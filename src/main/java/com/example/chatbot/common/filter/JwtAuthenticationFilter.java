package com.example.chatbot.common.filter;/** * JWT 토큰 검증 필터 * * @author : 오승훈 * @fileName : JwtAuthenticationFilter * @since : 2026-02-22 */import com.example.chatbot.common.util.JwtUtil;import jakarta.servlet.FilterChain;import jakarta.servlet.ServletException;import jakarta.servlet.http.HttpServletRequest;import jakarta.servlet.http.HttpServletResponse;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;import org.springframework.security.core.context.SecurityContextHolder;import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;import org.springframework.stereotype.Component;import org.springframework.web.filter.OncePerRequestFilter;import java.io.IOException;import java.util.ArrayList;@Slf4j@Component@RequiredArgsConstructorpublic class JwtAuthenticationFilter extends OncePerRequestFilter {  private final JwtUtil jwtUtil;  @Override  protected void doFilterInternal(HttpServletRequest request,      HttpServletResponse response,      FilterChain filterChain) throws ServletException, IOException {    // 1. Authorization 헤더에서 토큰 추출    String authHeader = request.getHeader("Authorization");    if (authHeader == null || !authHeader.startsWith("Bearer ")) {      filterChain.doFilter(request, response);      return;    }    try {      // 2. "Bearer " 제거하고 토큰만 추출      String token = authHeader.substring(7);      // 3. 토큰 검증      if (jwtUtil.validateToken(token)) {        // 4. 토큰에서 사용자 정보 추출        Long userId = jwtUtil.getUserIdFromToken(token);        String loginId = jwtUtil.getLoginIdFromToken(token);        // 5. Spring Security에 인증 정보 등록        UsernamePasswordAuthenticationToken authentication =            new UsernamePasswordAuthenticationToken(                userId,  // principal (현재 사용자 ID)                null,    // credentials (비밀번호는 필요 없음)                new ArrayList<>()  // authorities (권한)            );        authentication.setDetails(            new WebAuthenticationDetailsSource().buildDetails(request)        );        SecurityContextHolder.getContext().setAuthentication(authentication);        log.debug("JWT 인증 성공 - 사용자 ID: {}, 로그인 ID: {}", userId, loginId);      }    } catch (Exception e) {      log.error("JWT 인증 실패: {}", e.getMessage());    }    filterChain.doFilter(request, response);  }}