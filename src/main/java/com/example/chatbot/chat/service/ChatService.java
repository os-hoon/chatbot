package com.example.chatbot.chat.service;import com.example.chatbot.chat.dto.ChatResponse;import com.example.chatbot.chat.dto.ConversationDetailResponse;import com.example.chatbot.chat.dto.ConversationListResponse;import com.example.chatbot.chat.entity.Conversation;import com.example.chatbot.chat.repository.ConversationRepository;import com.example.chatbot.common.exception.ConversationNotFoundException;import com.example.chatbot.message.dto.MessageResponse;import com.example.chatbot.message.service.MessageService;import com.example.chatbot.openAI.dto.AiMessage;import com.example.chatbot.openAI.service.OpenAiService;import java.util.stream.Collectors;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.stereotype.Service;import java.util.ArrayList;import java.util.List;import org.springframework.transaction.annotation.Transactional;/** * 채팅 비즈니스 로직 서비스 * * @author : 오승훈 * @fileName : ChatService * @since : 2026-02-05 */@Slf4j@Service@RequiredArgsConstructor@Transactional(readOnly = true)public class ChatService {  private final OpenAiService openAiService;  private final ConversationRepository conversationRepository;  private final MessageService messageService;  /**   * 새로운 대화 시작 & 채팅   */  @Transactional  public ChatResponse chat(String userMessage) {    log.info("채팅 요청 - 사용자 메시지: {}", userMessage);    // 1. 새 대화 생성 (제목은 사용자 메시지의 앞 30자)    String title = userMessage.length() > 30        ? userMessage.substring(0, 30) + "..."        : userMessage;    Conversation conversation = Conversation.builder()        .title(title)        .build();    conversationRepository.save(conversation);    // 2. 사용자 메시지 저장    messageService.saveUserMessage(userMessage, conversation);    // 3. OpenAI 호출    List<AiMessage> aiMessages = new ArrayList<>();    aiMessages.add(new AiMessage("user", userMessage));    String aiResponse = openAiService.getChatCompletion(aiMessages);    // 4. AI 응답 메시지 저장    messageService.saveAssistantMessage(aiResponse, conversation);    log.info("채팅 응답 완료 - 대화 ID: {}", conversation.getConversationId());    return ChatResponse.of(aiResponse);  }  /**   * 대화 목록 조회   */  public List<ConversationListResponse> getConversationList() {    List<Conversation> conversations = conversationRepository.findAll();    return conversations.stream()        .map(ConversationListResponse::from)        .collect(Collectors.toList());  }  /**   * 대화 상세 조회 (메시지 포함)   */  public ConversationDetailResponse getConversationDetail(Long conversationId) {    Conversation conversation = conversationRepository.findById(conversationId)        .orElseThrow(() -> new ConversationNotFoundException(conversationId)); //공통 에러로 처리로 수정    List<MessageResponse> messages = messageService.getMessagesByConversationId(conversationId);    return new ConversationDetailResponse(        conversation.getConversationId(),        conversation.getTitle(),        conversation.getCreatedAt(),        conversation.getUpdatedAt(),        messages    );  }}