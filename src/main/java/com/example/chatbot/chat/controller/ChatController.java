package com.example.chatbot.chat.controller;import com.example.chatbot.chat.dto.ChatRequest;import com.example.chatbot.chat.dto.ChatResponse;import com.example.chatbot.chat.dto.ConversationDeleteResponse;import com.example.chatbot.chat.dto.ConversationDetailResponse;import com.example.chatbot.chat.dto.ConversationListResponse;import com.example.chatbot.chat.service.ChatService;import io.swagger.v3.oas.annotations.Operation;import io.swagger.v3.oas.annotations.Parameter;import io.swagger.v3.oas.annotations.media.Content;import io.swagger.v3.oas.annotations.media.Schema;import io.swagger.v3.oas.annotations.responses.ApiResponse;import io.swagger.v3.oas.annotations.responses.ApiResponses;import io.swagger.v3.oas.annotations.security.SecurityRequirement;import io.swagger.v3.oas.annotations.tags.Tag;import java.util.List;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.http.MediaType;import org.springframework.http.ResponseEntity;import org.springframework.security.core.Authentication;import org.springframework.web.bind.annotation.*;import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;/** * 채팅 API 컨트롤러 * * @author : 오승훈 * @fileName : ChatController * @since : 2026-02-05 */@Tag(name = "채팅", description = "AI 채팅 및 대화 관리 API")@SecurityRequirement(name = "JWT")@SecurityRequirement(name = "API-Key")@Slf4j@RestController@RequestMapping("/api/chat")@RequiredArgsConstructorpublic class ChatController {  private final ChatService chatService;  /**   * 채팅 API   *   * @param request 사용자 메시지   * @return AI 응답   */  @Operation(summary = "채팅", description = "새 대화를 시작하거나 기존 대화를 이어갑니다.")  @ApiResponses({      @ApiResponse(responseCode = "200", description = "응답 성공",          content = @Content(schema = @Schema(implementation = ChatResponse.class))),      @ApiResponse(responseCode = "401", description = "인증 실패"),      @ApiResponse(responseCode = "403", description = "접근 권한 없음")  })  @PostMapping  public ResponseEntity<ChatResponse> chat(@RequestBody ChatRequest request,      @Parameter(hidden = true) Authentication authentication) {    Long userId = (Long) authentication.getPrincipal();    log.info("채팅 요청 수신 - 사용자 ID: {}, 메시지: {}", userId, request.getMessage());    // ChatService를 통해 AI 응답 받기    ChatResponse response = chatService.chat(request.getMessage(),request.getConversationId(),userId);    return ResponseEntity.ok(response);  }  /**   * 채팅 스트리밍   */  @Operation(summary = "채팅 스트리밍", description = "실시간으로 AI 응답을 스트리밍합니다.")  @ApiResponses({      @ApiResponse(responseCode = "200", description = "스트리밍 시작"),      @ApiResponse(responseCode = "401", description = "인증 실패")  })  @PostMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)  public SseEmitter chatStream(@RequestBody ChatRequest request,      @Parameter(hidden = true) Authentication authentication) {    Long userId = (Long) authentication.getPrincipal();    log.info("채팅 스트리밍 요청 수신 - 사용자 ID: {}", userId);    return chatService.chatStream(        request.getMessage(),        request.getConversationId(),        userId    );  }  /**   * 대화 목록 조회   */  @Operation(summary = "내 대화 목록 조회", description = "로그인한 사용자의 대화 목록을 조회합니다.")  @ApiResponses({      @ApiResponse(responseCode = "200", description = "조회 성공"),      @ApiResponse(responseCode = "401", description = "인증 실패")  })  @GetMapping("/conversations")  public ResponseEntity<List<ConversationListResponse>> getConversations(      @Parameter(hidden = true) Authentication authentication) {    Long userId = (Long) authentication.getPrincipal();    log.info("대화 목록 조회 요청 - 사용자 ID: {}", userId);    List<ConversationListResponse> conversations = chatService.getConversationList(userId);    return ResponseEntity.ok(conversations);  }  /**   * 대화 상세 조회 (메시지 포함)   */  @Operation(summary = "대화 상세 조회", description = "특정 대화의 전체 메시지를 조회합니다.")  @ApiResponses({      @ApiResponse(responseCode = "200", description = "조회 성공",          content = @Content(schema = @Schema(implementation = ConversationDetailResponse.class))),      @ApiResponse(responseCode = "403", description = "접근 권한 없음"),      @ApiResponse(responseCode = "404", description = "대화를 찾을 수 없음")  })  @GetMapping("/conversations/{conversationId}")  public ResponseEntity<ConversationDetailResponse> getConversationDetail(      @Parameter(description = "대화 ID", required = true) @PathVariable Long conversationId,      @Parameter(hidden = true) Authentication authentication) {    Long userId = (Long) authentication.getPrincipal();    log.info("대화 상세 조회 요청 - 대화 ID: {}", conversationId, userId);    ConversationDetailResponse response = chatService.getConversationDetail(conversationId, userId);    return ResponseEntity.ok(response);  }  /**   * 대화 삭제   */  @Operation(summary = "대화 삭제", description = "특정 대화를 삭제합니다.")  @ApiResponses({      @ApiResponse(responseCode = "200", description = "삭제 성공",          content = @Content(schema = @Schema(implementation = ConversationDeleteResponse.class))),      @ApiResponse(responseCode = "403", description = "접근 권한 없음"),      @ApiResponse(responseCode = "404", description = "대화를 찾을 수 없음")  })  @DeleteMapping("/conversations/{conversationId}")  public ResponseEntity<ConversationDeleteResponse> deleteConversation(      @Parameter(description = "대화 ID", required = true) @PathVariable Long conversationId,      @Parameter(hidden = true) Authentication authentication) {    Long userId = (Long) authentication.getPrincipal();    log.info("대화 삭제 요청 - 대화 ID: {}, 사용자 ID: {}", conversationId, userId);    ConversationDeleteResponse response = chatService.deleteConversation(conversationId, userId);    return ResponseEntity.ok(response);  }  /**   * 대화 검색   */  @Operation(summary = "대화 검색", description = "제목으로 내 대화를 검색합니다.")  @ApiResponses({      @ApiResponse(responseCode = "200", description = "검색 성공"),      @ApiResponse(responseCode = "401", description = "인증 실패")  })  @GetMapping("/conversations/search")  public ResponseEntity<List<ConversationListResponse>> searchConversations(      @Parameter(description = "검색 키워드", required = true)@RequestParam String keyword,      @Parameter(hidden = true) Authentication authentication) {    Long userId = (Long) authentication.getPrincipal();    log.info("대화 검색 요청 - 키워드: {}, 사용자 ID: {}", keyword, userId);    List<ConversationListResponse> conversations = chatService.searchConversations(keyword, userId);    return ResponseEntity.ok(conversations);  }}