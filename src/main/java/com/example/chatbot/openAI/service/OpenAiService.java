package com.example.chatbot.openAI.service;import com.example.chatbot.common.exception.BusinessException;import com.example.chatbot.common.exception.ErrorCode;import com.example.chatbot.openAI.dto.AiMessage;import com.example.chatbot.openAI.dto.AiRequest;import com.example.chatbot.openAI.dto.AiResponse;import com.fasterxml.jackson.databind.JsonNode;import com.fasterxml.jackson.databind.ObjectMapper;import java.io.BufferedReader;import java.io.InputStreamReader;import java.net.HttpURLConnection;import java.net.URL;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Value;import org.springframework.http.HttpEntity;import org.springframework.http.HttpHeaders;import org.springframework.http.MediaType;import org.springframework.stereotype.Service;import org.springframework.web.client.RestTemplate;import java.util.List;import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;/** * OpenAI API 통신 서비스 * * @author : 오승훈 * @fileName : OpenAIService * @since : 2026-02-05 */@Slf4j@Service@RequiredArgsConstructorpublic class OpenAiService {  private final RestTemplate restTemplate;  private final ObjectMapper objectMapper = new ObjectMapper();  @Value("${openai.api-url}")  private String apiUrl;  @Value("${openai.model}")  private String model;  @Value("${openai.api-key}")  private String apiKey;  // 일반 호출  public String getChatCompletion(List<AiMessage> messages) {    try {      // 1. 요청 DTO 생성      AiRequest request = new AiRequest(model, messages);      log.info("OpenAI API 요청 - 모델: {}, 메시지 개수: {}", model, messages.size());      HttpEntity<AiRequest> entity = new HttpEntity<>(request);      // 4. API 호출      AiResponse response = restTemplate.postForObject(          apiUrl,          entity,  // ← HttpEntity로 전달          AiResponse.class      );      // 5. 응답 처리      if (response != null && response.getChoices() != null && !response.getChoices().isEmpty()) {        String content = response.getChoices().get(0).getMessage().getContent();        log.info("OpenAI API 응답 성공 - 내용 길이: {}", content.length());        return content;      }      log.warn("OpenAI API 응답이 비어있습니다.");      return "응답을 생성할 수 없습니다.";    } catch (Exception e) {      log.error("OpenAI API 호출 중 오류 발생", e);      throw new BusinessException(ErrorCode.OPENAI_API_ERROR); //공통 에러 처리로 수정    }  }  // 스트리밍 호출  public String getChatCompletionStream(List<AiMessage> messages, SseEmitter emitter) {    StringBuilder fullContent = new StringBuilder();    try {      // 스트리밍 요청      AiRequest request = new AiRequest(model, messages, true);      log.info("OpenAI 스트리밍 요청 - 모델: {}, 메시지 개수: {}", model, messages.size());      // HttpURLConnection으로 스트리밍 처리      URL url = new URL(apiUrl);      HttpURLConnection connection = (HttpURLConnection) url.openConnection();      connection.setRequestMethod("POST");      connection.setRequestProperty("Content-Type", "application/json");      connection.setRequestProperty("Authorization", "Bearer " + apiKey);      connection.setDoOutput(true);      // 요청 본문 작성      String jsonRequest = objectMapper.writeValueAsString(request);      connection.getOutputStream().write(jsonRequest.getBytes());      // 스트리밍 응답 읽기      BufferedReader reader = new BufferedReader(          new InputStreamReader(connection.getInputStream())      );      String line;      while ((line = reader.readLine()) != null) {        if (line.startsWith("data: ")) {          String data = line.substring(6);          if (data.equals("[DONE]")) {            log.info("스트리밍 완료");            break;          }          try {            // JSON 파싱하여 content 추출            JsonNode jsonNode = objectMapper.readTree(data);            JsonNode deltaNode = jsonNode.path("choices")                .get(0)                .path("delta");            if (deltaNode.has("content")) {              String content = deltaNode.get("content").asText();              fullContent.append(content);              // SSE로 클라이언트에 전송              emitter.send(SseEmitter.event()                  .data(content)                  .name("message"));            }          } catch (Exception e) {            log.debug("청크 파싱 스킵: {}", data);          }        }      }      reader.close();      emitter.complete();      log.info("OpenAI 스트리밍 응답 완료 - 전체 길이: {}", fullContent.length());      return fullContent.toString();    } catch (Exception e) {      log.error("OpenAI 스트리밍 중 오류 발생", e);      try {        emitter.completeWithError(e);      } catch (Exception ex) {        log.error("Emitter 에러 전송 실패", ex);      }      throw new BusinessException(ErrorCode.OPENAI_API_ERROR);    }  }}